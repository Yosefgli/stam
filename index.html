<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shift Tracker</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      font-family: sans-serif;
    }
    button {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      font-size: 32px;
      color: white;
      background-color: green;
    }
    .stop {
      background-color: red;
    }
    #timer {
      margin-top: 20px;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <button id="toggleBtn">▶</button>
  <div id="timer">00:00:00</div>

  <script>
    const ENTRY_WEBHOOK = "https://hook.integrator.boost.space/v6kx9oca4yospakzjwecgr2234t8khk3";
    const EXIT_WEBHOOK = "https://hook.integrator.boost.space/v6kx9oca4yospakzjwecgr2234t8khk3";

    const btn = document.getElementById("toggleBtn");
    const timerEl = document.getElementById("timer");

    let interval;

    function updateTimer(startTime) {
      clearInterval(interval);
      interval = setInterval(() => {
        const elapsed = Date.now() - new Date(startTime);
        const hours = String(Math.floor(elapsed / 3600000)).padStart(2, '0');
        const minutes = String(Math.floor((elapsed % 3600000) / 60000)).padStart(2, '0');
        const seconds = String(Math.floor((elapsed % 60000) / 1000)).padStart(2, '0');
        timerEl.textContent = `${hours}:${minutes}:${seconds}`;
      }, 1000);
    }

    function setButtonState(isWorking) {
      btn.textContent = isWorking ? '■' : '▶';
      btn.classList.toggle('stop', isWorking);
    }

    async function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          pos => resolve({
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
          }),
          err => reject(err)
        );
      });
    }

    async function sendWebhook(url, data) {
      await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    }

    btn.onclick = async () => {
      const employeeId = localStorage.getItem("employeeId");
      if (!employeeId) return alert("לא מוגדר employeeId");

      const isWorking = localStorage.getItem("isWorking") === 'true';
      const location = await getLocation();

      if (!isWorking) {
        // כניסה
        const res = await fetch(ENTRY_WEBHOOK, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            employeeId,
            action: 'start',
            location
          })
        });
        const result = await res.json();
        localStorage.setItem("isWorking", 'true');
        localStorage.setItem("shiftId", result.shiftId);
        localStorage.setItem("startTime", new Date().toISOString());
        setButtonState(true);
        updateTimer(localStorage.getItem("startTime"));
      } else {
        // יציאה
        await sendWebhook(EXIT_WEBHOOK, {
          employeeId,
          shiftId: localStorage.getItem("shiftId"),
          action: 'end',
          location
        });
        localStorage.removeItem("isWorking");
        localStorage.removeItem("shiftId");
        localStorage.removeItem("startTime");
        clearInterval(interval);
        timerEl.textContent = "00:00:00";
        setButtonState(false);
      }
    };

    // Restore state
    if (localStorage.getItem("isWorking") === 'true') {
      setButtonState(true);
      updateTimer(localStorage.getItem("startTime"));
    }
  </script>
</body>
</html>
